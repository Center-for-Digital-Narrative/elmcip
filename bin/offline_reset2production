#!/bin/bash

# Off-line version of reset2production.
#
# Reset you local installation from your latest downloaded
# database snapshot. Does no attempt to pull data from external systems.

#set -x

DRUPAL=drupal
URI=elmcip.local
DRUSH=../vendor/bin/drush
DB=../site/latest.elmcip.sql.gz
DB_DECOMPRESSED=../site/latest.elmcip.sql

./vendor/bin/drush --version || exit $?

git checkout production --quiet || exit $?
git submodule update --quiet || exit $?

cd ${DRUPAL} || exit

# Drop all data and populate database with the latest backup.
#
if [[ -z "$1" ]]; then

  if [ ! -f $DB ]; then
    echo "Error. Database file $DB not found. Giving up."
    exit 1
  fi

  echo "Running normal mode. Removing existing db tables."
  ${DRUSH} --uri=${URI} sql-drop --yes
  echo "Populating database with new data."
  gunzip -c $DB | ${DRUSH} --uri=${URI} sql-cli
else

  if [ ! -f $DB_DECOMPRESSED ]; then
    echo "Error. Database file $DB_DECOMPRESSED not found. Giving up."
    exit 1
  fi

  echo "Running fast mode. Removing existing db tables."
  ${DRUSH} --uri=${URI} sql-drop --yes
  echo "Populating database with new data."
  ${DRUSH} --uri=${URI} sql-cli < ../site/latest.elmcip.sql
fi

# Flush all drupal caches.
${DRUSH} cc all -v
${DRUSH} fra --yes
${DRUSH} status
${DRUSH} fl
