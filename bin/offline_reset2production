#!/bin/bash

# Off-line version of reset2production.
#
# Does no attempt to pull data from any external services.
# Useful to be able reset to last known production while your machine
# have no Internet connection.

set -x

DRUPAL=drupal
URI=elmcip.local
HOMEDIR=${PWD}

drush --version || exit $?

git checkout production --quiet || exit $?
git submodule update --quiet || exit $?

cd ${DRUPAL}

if [[ -z "$1" ]]; then
  # Drop all data and populate database with the latest backup.
  echo "Running normal mode."
  drush --uri=${URI} sql-drop --yes
  gunzip -c ../site/latest.elmcip.sql.gz | drush --uri=${URI} sql-cli
else
  # Run the fast version.
  echo "Running fast mode."
  drush --uri=${URI} sql-drop --yes
  drush --uri=${URI} sql-cli < ../site/latest.elmcip.sql
fi

# Flush all drupal caches.
drush cc all -v
drush fra --yes
drush status
drush fl
