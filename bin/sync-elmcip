#!/bin/bash

set -x

SITE=elmcip01.norstore.uio.no
DB_SITE=elmcip02.norstore.uio.no
DRUPAL=drupal
URI=elmcip.dev
HOMEDIR=${PWD}

drush --version || exit $?

# Sync directly from Nordnet servers.
rsync --update -h --modify-window=5 --stats --progress --delete --compress --recursive --verbose --exclude-from="bin/exclude_elmcip.txt" $SITE:/applications/elmcip.net/drupal/sites/default/files drupal/sites/default

# Grab a copy of latest production db.
rsync -L -h --stats --progress --verbose $DB_SITE:/files/latest.elmcip.sql.gz site/

# Restore/populate local database
cd $HOMEDIR/$DRUPAL || exit 1
gunzip -c ../site/latest.elmcip.sql.gz | drush --uri=$URI sql-cli

# Copy sandbox setting file to installation
cp ../site/settings.php sites/default/settings.php

# Normalize all synced files and directories to make sure they are locally writable
cd $HOMEDIR/sites/default || exit 1
find . -type f -exec chmod -v 666 '{}' \;
find . -type d -exec chmod -v 777 '{}' \;

# Flush all drupal caches
drush cc all -v
drush status
