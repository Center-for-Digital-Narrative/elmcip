#!/bin/bash

set -x

source bin/drush.sh
DRUPAL=drupal
URI=elmcip.local
HOMEDIR=${PWD}

drush --version || exit $?

# Copy default database settings to Drupal.
if [ -f $DRUPAL/sites/default/settings.php ]; then
    echo "Site already exist. Unable to initialize exiting sites."
    exit 1
fi

cp -v site/settings.php $DRUPAL/sites/default || exit 1
cp -v site/settings.local.php $DRUPAL/sites/default || exit 1

# Make sure are on the development branch all git submodules are up to date.
git checkout master
git pull --rebase --quiet || exit $?
git submodule update --quiet || exit $?

cd $DRUPAL || exit

# Populate the local database.
if [ -f ../site/latest.elmcip.sql.gz ]; then
    echo "No database copy found. Populate db. with, example: bin/reset2production"
else
    echo 'Populating database.'
    gunzip -c ../site/latest.elmcip.sql.gz | drush sql-cli
fi

# Create Drupal public directory.
cd $HOMEDIR/$DRUPAL/sites/default || exit 1
mkdir files
chmod 777 files

# Flush all drupal caches.
if [ -f ../site/latest.elmcip.sql.gz ]; then
    exit
fi

drush updatedb --yes
drush cc all
drush status
