<?php
/**
 * @file
 * Code for the Setup ELMCIP feature.
 */

include_once 'elmcip_setup.features.inc';

/**
 * Remove temporary index tables from views_export.
 *
 * Temporary index tables that have been left
 * behind. This is caused by batch processes which are
 * started but never finished.
 */
function elmcip_setup_update_7001() {
  if (module_exists('views_data_export')) {
    views_data_export_garbage_collect(0, -1);
  }
}

/**
 * Implements hook_block_info().
 */
function elmcip_setup_block_info() {
  return array('sosical_networks' => array(
    'info' => t('Social networks assosiated with ELMCIP.'),
    'cache' => 'DRUPAL_CACHE_GLOBAL',
    'weight' => 0,
    'status' => 1,
    'region' => 'header_top',
    'theme' => 'elmcip',
  ));
}

/**
 * Implements hook_block_view().
 */
function elmcip_setup_block_view($delta = '') {
  switch ($delta) {
    case 'sosical_networks':
      $content =  array(
        '#type' => 'markup',
        '#markup' => '
        <ul class="menu social">
          <li><a href="https://vimeo.com/elmcip"><i class="fa fa-vimeo-square"></i></a></li>
          <li><a href="https://twitter.com/elmcip"><i class="fa fa-twitter-square"></i></a></li>
          <li><a href="https://www.facebook.com/groups/480202502024095"><i class="fa fa-facebook-square"></i></a></li>
        </ul>',
      );
      $block = array(
        'content' => render($content),
      );
      return $block;

    default:
      break;
  }
}

/**
 * Implements hook_node_presave().
 */
function elmcip_setup_node_presave($node) {
  $content_types = array('person');
  foreach ($content_types as $content_type) {
    if ($node->type == $content_type) {
      if ($content_type = 'person') {
        $person = entity_metadata_wrapper('node', $node);
        $name = FALSE;
        if ($person->field_first_name->value()) {
          $name .= trim($person->field_first_name->value());
          $person->field_first_name->set(trim($person->field_first_name->value()));
        }
        if ($person->field_middle_name->value()) {
          $name .= ' ' . trim($person->field_middle_name->value());
          $person->field_middle_name->set(trim($person->field_middle_name->value()));
        }
        if ($person->field_last_name->value()) {
          $name .= ' ' . trim($person->field_last_name->value());
          $person->field_last_name->set(trim($person->field_last_name->value()));
        }
        if ($name) {
          $person->title->set($name);
        }
      }
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function elmcip_setup_form_person_node_form_alter(&$form, &$form_state, $form_id) {
  $form['title']['#type'] = 'hidden';
  $form['title']['#default_value'] = 'ELMCIP auto generated - dummy';
}
